
# 背景
基于universal-app框架统一视频多端（phone、pad、web）样式适配，因此需要统一的后台管理台抓取原有各端各业务后台的配置数据，各模块内部数据逻辑仍有原有各端各业务后台处理。

# 主要的功能点
![](https://yoo.qpic.cn/yoo_img/0/46496bd39d8265e4c4859b302f37a06b/0)

# 系统架构图
![](https://yoo.qpic.cn/yoo_img/0/1dc7c0137fa4a6d0c9ee829273f31aac/0)

# 数据库设计(先放详细定义，后续补上关系拓扑图)
http://tapd.oa.com/huoguo_fontend/markdown_wikis/?#1020408332010250477


# 一、基础支撑层的详细讲解
## 三种定义列表数据能力

## 1. 自定义业务模型
![图片描述](https://yoo.qpic.cn/yoo_img/0/98a088d2d02df162c09d03dfbe29b367/0)




### 1.1 数据流向过程
表示整个业务模型，从 **第三方数据 ---> 经过universal加工处理 ---> 数据的二次输出** 的整体流程
![](https://yoo.qpic.cn/yoo_img/0/a62dcd36a41dee38a5ca6b1dbe29dfc2/0)
### 1.2 定制外部数据
接受第三方接口、静态数据等方式，作为业务模型的外部数据，这部分数据会被解析为对应的表单字段，作为展示列，universal并不会对这部分数据做任何的修改。

### 1.3 定制字段
1. 定制字段的中英文名字、字段类型、默认值、是否支持排序筛选等
2. 针对枚举型字段，例如下拉框、单选框、多选框类型字段，可自定义数据，还可以关联第三方接口的数据做为数据源
3. 针对枚举型字段，例如下拉框、单选框、多选框类型字段，可关联其它业务模型，做到数据联动（暂定做解耦处理，选第一种处理方式，也就是做**复制操作**）
> 1、解耦处理：如果表2用了表1某个字段的下拉枚举值，“复制一份”，相当于每个表处理自己的数据逻辑
> 2、提示处理：如果表2用了表1某个字段的下拉枚举值，在表1删除了某个字段提示用户：请去表2将关联的字段解绑后才可以删除

### 1.4 钩子hook配置
把业务模型，从模块生命周期上进行细分，埋入钩子，便于业务模型的业务逻辑扩展
![](https://yoo.qpic.cn/yoo_img/0/490d142aeda3c4a508db4c9343b3261b/0)


### 1.5 插件包管理
插件包包含了版本号、作者、具体的插件逻辑执行代码、具体的挂载点（hook）等
#### 1.5.1 插件的安装、更新、卸载逻辑
插件属于运行依赖，天生支持热插拔。以**插件名+版本号**作为唯一标识，自动识别新安装还是版本更新。卸载时支持业务安全监测，给予详细的使用情况展示，保障业务的正常运行。
#### 1.5.2 插件包脚手架（后期考虑）
#### 1.5.3 插件包安装、更新、卸载可视化（后期考虑）


### 1.6 操作权限
每个业务模块，都包含三个权限
1. 可读（查看数据）
2. 可操作（可以编辑模型、编辑数据、删除数据）
3. 可删除（可以删除模型）

从角色来区分的话
1. 管理员：可读、可操作、可删除
2. 运营人员：可读、可操作
3. 访客：可读


## 2.  自定义管理台界面
### 2.1 路由定制
最多支持三级路由，路由与功能完全解耦，并且支持插件模块和外链
![](https://yoo.qpic.cn/yoo_img/0/4fd7e5efaa79f53c94bc31235c7d42f9/0)

### 2.2 风格定制(二期待定)

### 2.3 布局定制（二期待定）

## 3. 模块热插拔机制
预期规划会有染色模块、接口调试模块等相对通用的模块，会做成这种**插件模块**，它跟**用户定制的模块**最大区别在于，可以被多个业务方平滑接入，无需额外的开发，并且支持**热插拔（也就是即时生效）**

 !!#ff0000 这块晚点把细节补上!! 


## 4. 自定义数据模型（二期待定）

## 5. 数据快速调试测试（二期待定）







# 二、系统安全
## 1. 权限校验
 ~~会基于星海权限系统，进行权限的申请和管理~~ 
1. ~~星海权限系统：`http://shield.cm.com/config/1#/system`~~
2. ~~说明文档：`http://tvp.oa.com/stars/auth/auth_introduction.html`~~

使用敏感权限系统，具备OA登录 + 权限校验 的能力
借助open-api，实现用户系统权限的无感知注册、权限隔离、统一管理审批流程
### 1.1 权限动态注册
定义业务模型的同时，会通过node-proxy代理层服务器，请求敏感进行动态注册权限操作，并自动分配给对应的三种角色（管理者、运营人员、访客）。

### 1.2 权限隔离
基础的操作和角色，会以业务为单位进行隔离，不会出现权限串业务的情况

### 1.3 审批流程
暂时统一一个审批流程，如后期需要，可以动态调整为以操作为单位的审批流程
![](https://yoo.qpic.cn/yoo_img/0/fca63d0b478ddfffbd9784385487cb9d/0)
暂定两级审批，之后可以灵活修改

## 2. 日志系统
### 2.1 远程日志接入（基于boss和鹰眼）
主要依赖于[boss](http://beehive.boss.webdev.com) 和 [鹰眼](http://log2.webdev.com/)
> PS:注意鹰眼的内容只能存储7天
### 2.2 本地日志（基于taf机器）
日志主要存储在服务器，路径是 **/usr/local/app/taf/app_log/huoguoCMS/huoguoCMS**,更多时候我们只需要[在线查看](http://logview.wsd.com/log_server/local_log_view.action?path=taf.huoguoCMS.huoguoCMS.PSZ184:/usr/local/app/taf/app_log/huoguoCMS/huoguoCMS)即可。
具体参考[@tencent/taf-logs](http://tnpm.oa.com/package/@tencent/taf-logs)
日志可以直接在taf管理页面上操作查看

### 2.3 业务操作日志 （存本地库）
覆盖业务模型的操作、数据操作、系统相关配置操作

## 3. 接口调用量监控
### 3.1 棱镜monitor2
更多是用来监控node提供的接口调用情况，例如调用量、耗时、报错率

### 3.2 mcall
主要用于调用量的统计，并且可以设置告警

# 三、 接口协议

## 1. 标准restful API设计接口
### 1.1 标准数据输入（待定）

### 1.2 标准数据输出（待定）

## 2. TRPC协议接口（待定）
### 2.1 TRPC的实现
基于[trpc-node框架](https://git.code.oa.com/trpc-node/trpc-rpc/blob/master/docs/quick-start.md)，框架架构图如下：
![图片描述](https://yoo.qpic.cn/yoo_img/0/9dbaab89d2b51dd932f8a9ebbdebb23e/0)
部署主要放在[123.oa.com](http://sumeru.pages.oa.com/publish/formal.html)

### 2.2 TRPC的使用情况
1. 公司级的`trpc-node库`暂时不支持http/https协议的调用，所以使用场景会比较狭隘，尤其是管理台场景下。
2. 部署环境有要求，暂时只能在123.oa.com的服务集群里部署，限制会比较多，且相对配套功能不全。
3. 暂定的规划，是在数据接出时，用TRPC做一个微服务试水
